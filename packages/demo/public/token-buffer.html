<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Morphgrid Cohesive Text Demo</title>
  <style>
    body { font-family: sans-serif; }
    .row { margin: 8px 0; }
    input[type=text] { width: 400px; }
    .out { background:#111;color:#0f0;padding:8px;min-height:3em;white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>Morphgrid Cohesive Text Demo</h1>
  <p style="max-width:70ch;">
    This tool renders a sequence of tokens as cohesive text, applying language-specific joining rules
    (e.g., elision and spacing). Try the examples below by pasting them into the “Tokens” field and selecting
    the matching language:
  </p>
  <ul>
    <li><strong>fr-FR</strong>: <code>je aime , il arrive</code> → j’aime, il arrive</li>
    <li><strong>fr-FR</strong>: <code>le homme</code> → l’homme; <code>le hérisson</code> → le hérisson</li>
    <li><strong>it-IT</strong>: <code>lo amico</code> → l’amico; <code>una amica</code> → un’amica</li>
    <li><strong>en-US</strong>: <code>a apple</code> → an apple; <code>sing ing</code> → singing</li>
  </ul>
  <div class="row">
    <label>Language:
      <select id="lang">
        <option value="fr-FR" selected>fr-FR</option>
        <option value="en-US">en-US</option>
        <option value="it-IT">it-IT</option>
        <option value="es-ES">es-ES</option>
        <option value="de-DE">de-DE</option>
        <option value="fi-FI">fi-FI</option>
        <option value="cy-GB">cy-GB</option>
        <option value="eu-ES">eu-ES</option>
      </select>
    </label>
  </div>
  <div class="row">
    <label>Use example:
      <select id="example">
        <optgroup label="fr-FR">
          <option value="je aime , il arrive">je aime , il arrive → j’aime, il arrive</option>
          <option value="le homme">le homme → l’homme</option>
          <option value="le hérisson">le hérisson → le hérisson</option>
        </optgroup>
        <optgroup label="it-IT">
          <option value="lo amico">lo amico → l’amico</option>
          <option value="una amica">una amica → un’amica</option>
        </optgroup>
        <optgroup label="en-US">
          <option value="a apple">a apple → an apple</option>
          <option value="sing ing">sing ing → singing</option>
        </optgroup>
        <optgroup label="es-ES">
          <option value="el agua">el agua (contraction often dialectal) → el agua</option>
          <option value="quiero le+dar">quiero le+dar → quiero darle</option>
        </optgroup>
        <optgroup label="de-DE">
          <option value="Haus Tür">Haus Tür → Haustür</option>
        </optgroup>
        <optgroup label="fi-FI">
          <option value="talo ssa">talo ssa → talossa</option>
          <option value="tietokone ohjelma">tietokone ohjelma → tietokoneohjelma</option>
        </optgroup>
        <optgroup label="cy-GB">
          <option value="yr ysgol">yr ysgol (article before vowel)</option>
          <option value="yn Nghymru">yn Nghymru (soft mutation after ‘yn’)</option>
        </optgroup>
        <optgroup label="eu-ES">
          <option value="etxe handi">etxe handi → etxe handi (adj after noun)</option>
          <option value="gizon bat">gizon bat → gizon bat (indefinite after noun)</option>
        </optgroup>
      </select>
    </label>
  </div>
  <div class="row">
    <label>Tokens (space-separated):
      <input id="tokens" type="text" value="je aime , il arrive" />
    </label>
    <button id="render">Render Cohesive</button>
  </div>
  <div class="row">
    <label>Tag order policy:
      <select id="tagPolicy">
        <option value="flexible" selected>flexible</option>
        <option value="strict">strict</option>
      </select>
    </label>
  </div>
  <div class="row">
    <pre id="log" class="out"></pre>
  </div>
  <div class="row">
    <strong>Rendered:</strong> <span id="rendered"></span>
  </div>

  <script type="module">
    import { morph, configureMorphRuntime, configureMorphHfst, configureTagOrdering } from 'https://cdn.jsdelivr.net/npm/@morphgrid/core@latest/dist/index.js';
    configureMorphRuntime('hfst');
    configureMorphHfst({ wasmUrl: 'https://cdn.jsdelivr.net/npm/@morphgrid/core@latest/public/wasm/hfst.wasm' });

    const log = document.getElementById('log');
    const exampleSel = document.getElementById('example');
    function logLine(msg) { log.textContent += (msg + "\n"); }

    const langSel = document.getElementById('lang');
    const tokensEl = document.getElementById('tokens');
    const policySel = document.getElementById('tagPolicy');
    const outSpan = document.getElementById('rendered');
    await morph.load(langSel.value);

    // When an example is chosen, set tokens and optionally switch language group
    exampleSel.addEventListener('change', async () => {
      const txt = exampleSel.value;
      tokensEl.value = txt;
      // If the example belongs to a specific language group, align the selection
      const grp = exampleSel.selectedOptions[0]?.parentElement?.label;
      if (grp && langSel.value !== grp) {
        langSel.value = grp;
        await morph.load(langSel.value);
      }
      await renderCohesive();
    });

    async function joinPair(prev, next, lang) {
      // Use morph.join (rule-based) for now
      return await morph.join(prev, next, lang);
    }

    function renderFromDecision(decision) {
      return decision.noSpace
        ? decision.surfacePrev + decision.surfaceNext
        : decision.surfacePrev + (decision.joiner || ' ') + decision.surfaceNext;
    }

    async function renderCohesive() {
      const lang = langSel.value;
      configureTagOrdering(policySel.value);
      const toks = tokensEl.value.trim().split(/\s+/).filter(Boolean);
      outSpan.textContent = '';
      log.textContent = '';
      if (toks.length === 0) return;

      let rendered = toks[0];
      for (let i = 1; i < toks.length; i++) {
        const dec = await joinPair(rendered, toks[i], lang);
        rendered = renderFromDecision(dec);
        logLine(JSON.stringify(dec));
      }
      outSpan.textContent = rendered;
    }

    document.getElementById('render').onclick = renderCohesive;
    policySel.addEventListener('change', renderCohesive);
    langSel.addEventListener('change', async () => { await morph.load(langSel.value); await renderCohesive(); });
  </script>
</body>
</html>

